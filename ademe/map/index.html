<!DOCTYPE html>
<html>
 <head>
  <link href="//http:netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <meta charset="utf-8">
    <style type="text/css">

      .departement {
        cursor: pointer;
        stroke:white;
        stroke-width:.5px;
      }

      .departement:hover {
        stroke: white;
        stroke-width: 1.5px;
      }
    </style>
  </head>
  <body>

  
  <form>
  <fieldset>
    <legend>Année</legend>
    <div class="selectbox">
      <select class="form-control" id='selectYear'>
      <option value ="all">ALL</option>
      <option value ="2012">2012</option>
      <option value ="2011">2011</option>
      <option value ="2010">2010</option>
      <option value ="2009">2009</option>
      <option value ="2008">2008</option>
    </select>
    </div>
    <!--<button type="submit" class="btn btn-default">Submit</button>-->
  </fieldset>
  </form>



    <div id="map"></div>
    <script type="text/javascript" src="http://d3js.org/d3.v3.min.js"></script>
      <script src="HTTP://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>

    <script type="text/javascript">
    (function() {
 
      $.ajax({
          type: "GET",
          url: "deee.csv",
          dataType: "text",
          success: function(data) {processData(data);}
      });
  
    function getSelectValue(selectId) {
      var elmt = document.getElementById(selectId);
      if (elmt.multiple == false) {
        return elmt.options[elmt.selectedIndex].value;
      }
      var values = new Array();
      for (var i = 0; i < elmt.options.length; i++) {
        if (elmt.options[i].selected == true) {
          values[values.length] = elmt.options[i].value;
        }
      }
      return values;
    }

    function processData(allText) {
      var allTextLines = allText.split(/\r\n|\n/);
      var headers = allTextLines[0].split(',');
      var lines = [];

      for (var i=1; i<allTextLines.length; i++) {
          var data = allTextLines[i].split(',');
          if (data.length == headers.length) {

              var line = {};
              for (var j=0; j<headers.length; j++) {
                  line[headers[j]] = data[j];
              }
              lines.push(line);
          }
      }

        var dpts = {}; 
        for (i in lines){
          var line = lines[i];
          var dpt = line["dpt"];
          var flux = line["flux"];
          var tonnage = Number(line["tonnage"]);
          var annee = Number(line["annee"]);
          var id = dpt   ; //+ "-" + flux;
        
        //
          var selection =  getSelectValue('selectYear');
          if (dpts[id]) {
            if (selection === "all") {
              tonnage = Number(dpts[id]) + tonnage;
            } else if(annee===selection) {
              tonnage = Number(dpts[id]) + tonnage;
            }
          }
          dpts[id] = tonnage;
        //
        }

    var sum = 0;
    var count = 0;
        for (i in dpts){
          sum = sum+ dpts[i];
          count++;
        }
      var avg = sum /count;
        
      var colors = function (idpt){
        var dpt = idpt;
        if (dpt==="2a") dpt = "2A";
        if (dpt==="2b") dpt = "2B";
        if (dpt==="01") dpt = "1";
        if (dpt==="02") dpt = "2";
        if (dpt==="03") dpt = "3";
        if (dpt==="04") dpt = "4";
        if (dpt==="05") dpt = "5";
        if (dpt==="06") dpt = "6";
        if (dpt==="07") dpt = "7";
        if (dpt==="08") dpt = "8";
        if (dpt==="09") dpt = "9";

        if (dpts[dpt]> (3*avg)) return "#c00"; //rouge foncé
        if (dpts[dpt]> (2*avg)) return "#f44"; //rouge
        if (dpts[dpt]> (avg)) return "#f80"; //orange foncé
        if (dpts[dpt]< (avg/3))  return "#690"; //vert foncéé
        if (dpts[dpt]< (avg/2))  return "#9C0"; //vert
        if (dpts[dpt]) return "#fB3" //orange
        return "#ccc"; //gris pas de données
      }

      var width = 1200;
      var height = 800;

      /* 
       * On créait un nouvel objet path qui permet 
       * de manipuler les données géographiques.
       */
      var path = d3.geo.path();

      // On définit les propriétés de la projection à utiliser
      var projection = d3.geo.conicConformal() // Lambert-93
              .center([2.454071, 47.279229]) // On centre la carte sur la France
              .scale(4500)
              .translate([width / 2, height / 2]);

      path.projection(projection); // On assigne la projection au path

      /*
       * On créait un nouvel élément svg à la racine de notre div #map,
       * définie plus haut dans le HTML
       */
      var svg = d3.select('#map').append("svg")
          .attr("width", width)
          .attr("height", height);

      /*
       * On créait un groupe SVG qui va accueillir
       * tous nos départements
       */
      var deps = svg
          .append("g")
          .attr("id", "departements");

      /*
       * On charge les données GeoJSON
       */
      d3.json('departements.json', function(req, geojson) {

        /*
         * On "bind" un élément SVG path pour chaque entrée
         * du tableau features de notre objet geojson
         */
        var features = deps
            .selectAll("path")
            .data(geojson.features);
        /*
         * On créait un ColorScale, qui va nous
         * permettre d'assigner plus tard une
         * couleur de fond à chacun de nos
         * départements
         */
        var colorScale = d3.scale.category20c();
        /*
         * Pour chaque entrée du tableau feature, on
         * créait un élément SVG path, avec les
         * propriétés suivantes
         */
        features.enter()
          .append("path")
            .attr('class', 'departement')
            .attr('fill', function(d) { 
              //return colorScale(+d.properties.CODE_DEPT); 
              return colors(d.properties.CODE_DEPT);
            })
            .attr("d", path);//            .on('click', countyClickHandler);
     
      
      svg.selectAll(".subunit-label")
          .data(geojson.features)
        .enter().append("text")
          .attr("class", function(d) { return "subunit-label " + d.id; })
          .attr("transform", function(d) { return "translate(" + path.centroid(d) + ")"; })
          .attr("dy", ".35em")
            .text(function(d) { return d.properties.CODE_DEPT;});

 });

    };

      
      //Représentation du zoom sur paris et les 3 departements. (75,92,93,94)
      


      //Représentation des doms
      
  


      /*
       * Fonction qui permet de zoomer sur la carte
       * en cliquant sur les départements
       * Récupéré ici : http://bl.ocks.org/mbostock/2206340
       */
      /*var centered;
      function countyClickHandler(d) {
        var x, y, k;

        if (d && centered !== d) {
          var centroid = path.centroid(d);
          x = centroid[0];
          y = centroid[1];
          k = 5;
          centered = d;
        } else {
          x = width / 2;
          y = height / 2;
          k = 1;
          centered = null;
        }

        deps.selectAll("path")
          .classed("active", centered && function(d) { return d === centered; });

        var trStr = "translate(" + width / 2 + "," + height / 2 + ")" +
          "scale(" + k + ")translate(" + -x + "," + -y + ")";
        
        deps.transition()
          .duration(1000)
          .attr("transform", trStr);

      };*/

    }());
    </script>

  </body>
</html>