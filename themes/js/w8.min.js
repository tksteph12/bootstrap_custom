jQuery(function() {
    setGlobalParameters();
    handle_side_menu();
    fillSectorSelections();
    enable_search_ahead();
    add_browser_detection(jQuery);
    general_things();
    widget_boxes();
    updateMap("");


    $(document).off("click.dropdown-menu")
});

//Paramètres globaux

function setGlobalParameters() {
    var parameters = {};

    parameters.filieres = [{
            sector: "PA",
            label: "Piles et Accumulateurs",
            sourcefile: ""
        }, {
            sector: "DEE",
            label: "Dechets Équipements électriques et electroniques",
            sourcefile: ""
        }
    ];

    mapParameters = {
        typeOfdata: "collecte",
        filiere: "",
        types: [] // types d'équipements ou types d' piles/Accumulateurs
    }
}

function handle_side_menu() {
    $("#menu-toggler").on("click", function() {
        $("#sidebar").toggleClass("display");
        $(this).toggleClass("display");
        return false
    });
    var a = false;
    $("#sidebar-collapse").on("click", function() {
        /*$("#sidebar").toggleClass("menu-min");
        $(this.firstChild).toggleClass("icon-double-angle-right");
        a = $("#sidebar").hasClass("menu-min");
        if (a) {
            $(".open > .submenu").removeClass("open")
        }
        */
    });
    $(".nav-list").on("click", function(d) {
        if (a) {
            return
        }
        var c = $(d.target).closest(".dropdown-toggle");
        if (c && c.length > 0) {
            var b = c.next().get(0);
            if (!$(b).is(":visible")) {
                $(".open > .submenu").each(function() {
                    if (this != b && !$(this.parentNode).hasClass("active")) {
                        $(this).slideUp(200).parent().removeClass("open")
                    }
                })
            }
            $(b).slideToggle(200).parent().toggleClass("open");
            return false
        }
    })
}

function enable_search_ahead() {
    $("#nav-search-input").typeahead({
        source: ["Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia", "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland", "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey", "New Mexico", "New York", "North Dakota", "North Carolina", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina", "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming"],
        updater: function(a) {
            $("#nav-search-input").focus();
            console.log(parameters.filieres);
            return a
        }
    })
}

function general_things() {

    $('.ace-nav [class*="icon-animated-"]').closest("a").on("click", function() {
        var b = $(this).find('[class*="icon-animated-"]').eq(0);
        var a = b.attr("class").match(/icon\-animated\-([\d\w]+)/);
        b.removeClass(a[0]);
        $(this).off("click")
    });
    $("#ace-settings-btn").on("click", function() {
        $(this).toggleClass("open");
        $("#ace-settings-box").toggleClass("open")
    });
    $("#ace-settings-procuced").removeAttr("checked").on("click", function() {
        if (this.checked) {
            $("#ace-settings-collect").removeAttr("checked");
            mapParameters.typeOfdata = "production";
            updateMap("produced");
        }
    });
    $("#ace-settings-collect").removeAttr("checked").on("click", function() {
        if (this.checked) {
            $("#ace-settings-procuced").removeAttr("checked");
            mapParameters.typeOfdata = "collecte";
            updateMap("collected");
        }
    });
    $("#btn-scroll-up").on("click", function() {
        var a = Math.max(100, parseInt($("html").scrollTop() / 3));
        $("html,body").animate({
            scrollTop: 0
        }, a);
        return false
    });

    $("#sectorSelector").change(function(event) {

        var filiere = $('#sectorSelector option:selected').text();
        fetchCheckboxOptions(filiere);
        
        
        updateMap();
    });

    // choix du type de données à afficher : collecte ou production



    //initializing the select boxes

}

// récupère les types de la filière passée en paramètre
//faire une requête ajax qui renvoie les valeurs des types dans un tableau
function fetchCheckboxOptions( filiere){
            var tab = [];
            $.ajax({
              type: "GET",
              url: "deee.csv",
              dataType: "text",
              success: function(data,filiere) {
                 loadcheckboxOptions(data,filiere);
              }
            });

    return tab;
}


function loadcheckboxOptions(data,filiere){

    var tab = [];
    var aux = [];
    var allTextLines = data.split(/\r\n|\n/);
      var headers = allTextLines[0].split(',');
      var lines = [];

      for (var i = 1; i < allTextLines.length; i++) {
        var data = allTextLines[i].split(',');
        if (data.length == headers.length) {

          var line = {};
          for (var j = 0; j < headers.length; j++) {
            line[headers[j]] = data[j];
          }
          lines.push(line);
        }
      }

      var i=0;
      for (l in lines) {
        var line = lines[l];
        var flux = line["flux"];
        var pos = aux.indexOf(flux);
        if(pos === -1){
          i++
          aux.push(flux);
          tab.push({
            id:i,
            label:flux,
            isChecked:true
          });
            
        }
      }
          
      delete aux;


      $('#changingCheckboxes').dropdownCheckbox({
            data: tab,
            autosearch: true,
            title: "My Dropdown Checkbox",
            hideHeader: true,
            templateButton: '<a class="dropdown-checkbox-toggle" data-toggle="dropdown" href="#">Type de matériel<b class="caret"></b></button>'
        });

      return tab;
}

function widget_boxes() {
    $(".widget-toolbar > a[data-action]").each(function() {
        var f = $(this);
        var h = f.data("action");
        var e = f.closest(".widget-box");
        if (h == "collapse") {
            var d = e.find(".widget-body");
            var b = f.find("[class*=icon-]").eq(0);
            var a = b.attr("class").match(/icon\-(.*)\-(up|down)/);
            var c = "icon-" + a[1] + "-down";
            var g = "icon-" + a[1] + "-up";
            d = d.wrapInner('<div class="widget-body-inner"></div>').find(":first-child").eq(0);
            f.on("click", function(i) {
                if (e.hasClass("collapsed")) {
                    if (b) {
                        b.addClass(g).removeClass(c)
                    }
                    e.removeClass("collapsed");
                    d.slideDown(200)
                } else {
                    if (b) {
                        b.addClass(c).removeClass(g)
                    }
                    d.slideUp(300, function() {
                        e.addClass("collapsed")
                    })
                }
                i.preventDefault()
            });
            if (e.hasClass("collapsed") && b) {
                b.addClass(c).removeClass(g)
            }
        } else {
            if (h == "close") {
                f.on("click", function(i) {
                    e.hide(300, function() {
                        e.remove()
                    });
                    i.preventDefault()
                })
            } else {
                if (h == "reload") {
                    f.on("click", function(j) {
                        f.blur();
                        var i = false;
                        if (!e.hasClass("position-relative")) {
                            i = true;
                            e.addClass("position-relative")
                        }
                        e.append('<div class="widget-box-layer"><i class="icon-spinner icon-spin icon-2x white"></i></div>');
                        setTimeout(function() {
                            e.find("> div:last-child").remove();
                            if (i) {
                                e.removeClass("position-relative")
                            }
                        }, parseInt(Math.random() * 1000 + 1000));
                        j.preventDefault()
                    })
                } else {
                    if (h == "settings") {
                        f.on("click", function(i) {
                            i.preventDefault()
                        })
                    }
                }
            }
        }
    })
}

//remplir le menu de selection du choix de filières
function fillSectorSelections(){}

function updateMap() { // produced or collected data

    if ($('mapcontainer')) {
        $("#mapcontainer").html("");
    }
    if (mapParameters.typeOfdata === "production"){
        alert("Données non disponible");
        return 
    }
    $('#mapcontainer').drawMap({}, 'mapcontainer');
}

function add_browser_detection(c) {
    if (!c.browser) {
        var a, b;
        c.uaMatch = function(e) {
            e = e.toLowerCase();
            var d = /(chrome)[ \/]([\w.]+)/.exec(e) || /(webkit)[ \/]([\w.]+)/.exec(e) || /(opera)(?:.*version|)[ \/]([\w.]+)/.exec(e) || /(msie) ([\w.]+)/.exec(e) || e.indexOf("compatible") < 0 && /(mozilla)(?:.*? rv:([\w.]+)|)/.exec(e) || [];
            return {
                browser: d[1] || "",
                version: d[2] || "0"
            }
        };
        a = c.uaMatch(navigator.userAgent);
        b = {};
        if (a.browser) {
            b[a.browser] = true;
            b.version = a.version
        }
        if (b.chrome) {
            b.webkit = true
        } else {
            if (b.webkit) {
                b.safari = true
            }
        }
        c.browser = b
    }
};


//************************Variables globales************************************************

var parameters = {};

parameters.filieres = [{
        sector: "PA",
        label: "Piles et Accumulateurs",
        sourcefile: ""
    }, {
        sector: "DEE",
        label: "Dechets Équipements électriques et electroniques",
        sourcefile: ""
    }
];
mapParameters = {
    typeOfdata: "collecte", //default
    filiere: "PA", //default
    types: [] // types d'équipements ou types d' piles/Accumulateurs
}